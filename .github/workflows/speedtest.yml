# .github/workflows/speedtest.yml
name: 20x Ookla Speedtest

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"   # –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤ (—É–±–µ—Ä–∏—Ç–µ, –µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–æ)

jobs:
  speedtest:
    runs-on: ubuntu-latest      # noble 24.04, –≤—Å—ë –æ–∫

    steps:
    ###################################################################
    # 1. –î–æ–±–∞–≤–ª—è–µ–º jammy-—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ —Å—Ç–∞–≤–∏–º speedtest
    ###################################################################
    - name: üõ†Ô∏è Install Ookla speedtest (jammy repo on noble)
      run: |
        set -e
        sudo apt-get update -qq
        sudo apt-get install -yqq curl gnupg zip

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á
        curl -fsSL https://packagecloud.io/ookla/speedtest-cli/gpgkey \
          | sudo tee /etc/apt/keyrings/ookla_speedtest.gpg > /dev/null

        # –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º –∏ —É–∫–∞–∑—ã–≤–∞–µ–º –∏–º–µ–Ω–Ω–æ jammy
        echo "deb [arch=$(dpkg --print-architecture) \
              signed-by=/etc/apt/keyrings/ookla_speedtest.gpg] \
              https://packagecloud.io/ookla/speedtest-cli/ubuntu/ jammy main" \
          | sudo tee /etc/apt/sources.list.d/ookla_speedtest.list

        sudo apt-get update -qq
        sudo apt-get install -yqq speedtest
        speedtest --version      # sanity-check

    ###################################################################
    # 2. –ó–∞–ø—É—Å–∫–∞–µ–º 20 —Ç–µ—Å—Ç–æ–≤
    ###################################################################
    - name: üöÄ Run 20 speedtests
      run: |
        mkdir -p results
        for i in $(seq -w 1 20); do
          echo "‚ñ∫ Test #$i"
          speedtest --accept-license --accept-gdpr -f json \
            > results/speedtest_$i.json
        done

    ###################################################################
    # 3. –î–µ–ª–∞–µ–º zip-–∞—Ä—Ö–∏–≤
    ###################################################################
    - name: üì¶ Zip results
      run: |
        ZIP_NAME="speedtests_$(date +%Y%m%d_%H%M%S).zip"
        zip -qr "$ZIP_NAME" results
        echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

    ###################################################################
    # 4. –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç (v4)
    ###################################################################
    - name: ‚¨ÜÔ∏è Upload artifact
      uses: actions/upload-artifact@v4
      with:
        artifact-name: ${{ env.ZIP_NAME }}   # v4 ‚Üí artifact-name
        path: ${{ env.ZIP_NAME }}
        retention-days: 30

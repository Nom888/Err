name: 20x Ookla Speedtest
on:
  workflow_dispatch:

jobs:
  speedtest:
    runs-on: ubuntu-latest       # noble 24.04

    steps:
    ##################################################################
    # 1) –î–æ–±–∞–≤–ª—è–µ–º repo ¬´jammy¬ª + –∫–ª—é—á (dearmored)
    ##################################################################
    - name: üõ†Ô∏è Install Ookla speedtest (jammy repo on noble)
      run: |
        set -e

        # –±–∞–∑–æ–≤—ã–µ —É—Ç–∏–ª–∏—Ç—ã
        sudo apt-get update -qq
        sudo apt-get install -yqq curl gnupg2 ca-certificates zip

        # –ø—É—Ç—å –¥–ª—è –∫–ª—é—á–µ–π
        sudo mkdir -p /etc/apt/keyrings

        # ‚ö†Ô∏è  dearmor-–∫–ª—é—á, —á—Ç–æ–±—ã apt –µ–≥–æ ¬´—É–≤–∏–¥–µ–ª¬ª
        curl -fsSL https://packagecloud.io/ookla/speedtest-cli/gpgkey \
          | sudo gpg --dearmor --yes -o /etc/apt/keyrings/ookla_speedtest.gpg

        # —Å–∞–º –∏—Å—Ç–æ—á–Ω–∏–∫ (jammy). –ê—Ä—Ö –¥–æ—Å—Ç–∞—ë–º –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ.
        ARCH=$(dpkg --print-architecture)
        echo "deb [arch=${ARCH} signed-by=/etc/apt/keyrings/ookla_speedtest.gpg] \
              https://packagecloud.io/ookla/speedtest-cli/ubuntu/ jammy main" \
          | sudo tee /etc/apt/sources.list.d/ookla_speedtest.list

        sudo apt-get update -qq
        sudo apt-get install -yqq speedtest
        speedtest --version

    ##################################################################
    # 2) 20 –ø—Ä–æ–≥–æ–Ω–æ–≤
    ##################################################################
    - name: üöÄ Run 20 speedtests
      run: |
        mkdir -p results
        for i in $(seq -w 1 20); do
          echo "‚ñ∫ Test #$i"
          speedtest --accept-license --accept-gdpr -f json \
            > results/speedtest_$i.json
        done

    ##################################################################
    # 3) zip-–∞—Ä—Ö–∏–≤
    ##################################################################
    - name: üì¶ Zip results
      run: |
        ZIP_NAME="speedtests_$(date +%Y%m%d_%H%M%S).zip"
        zip -qr "$ZIP_NAME" results
        echo "ZIP_NAME=$ZIP_NAME" >> $GITHUB_ENV

    ##################################################################
    # 4) upload-artifact v4
    ##################################################################
    - name: ‚¨ÜÔ∏è Upload artifact
      uses: actions/upload-artifact@v4
      with:
        artifact-name: ${{ env.ZIP_NAME }}
        path:          ${{ env.ZIP_NAME }}
        retention-days: 30
